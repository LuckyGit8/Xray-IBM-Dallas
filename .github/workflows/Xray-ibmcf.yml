name: IBM Cloud Foundry

on:
  workflow_dispatch:
  repository_dispatch:
  #schedule:
    #- cron: 35 21 * * 2
 
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      APP_NAME: luli   
      
    steps:
    
    - name: Install Cloud Foundry CLI
      run: |
        curl -fsSL "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=v7&source=github" | tar -zxC /tmp
        sudo install -m 755 /tmp/cf7 /usr/local/bin/cf
        cf version
    - name: Login In
      run: |
         cf login \
           -a https://api.eu-gb.cf.cloud.ibm.com login -u yogok73835@dvdoto.com -p _@#_Qw_As_369_
    - name: Download App
      run: |
        DOWNLOAD_URL="https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip"
        curl -fsSL "$DOWNLOAD_URL" -o "latest-xray.zip"
        unzip latest-xray.zip xray geoip.dat geosite.dat
        rm latest-xray.zip
        chmod -v 755 xr*
        mv xray ${APP_NAME}
    - name: Generate Config File (VMess)
      run: |
        base64 << asd > config
        {
          "log": {
            "access": "none",
            "loglevel": "error"
          },
          "inbounds": [
            {
              "port": 8080,
              "protocol": "vmess",
              "settings": {
                "clients": [
                  {
                    "id": "8db9d919-ed31-4d65-bddb-4e2ab372f9a7}",
                    "alterId": 1
                  }
                ]
              },
              "streamSettings": {
                "network":"ws",
                "wsSettings": {
                  "path": "vmess-IBM"
                }
              }
            }
          ],
          "outbounds": [
            {
              "protocol": "freedom"
            }
          ]
        }
             
    - name: Generate Manifest File
      run: |
        cat << asd > manifest.yml
        applications:
        - name: ${APP_NAME}
          memory: 128M
          random-route: true
          command: base64 -d config > config.json; ./${APP_NAME} -config=config.json
          buildpacks:
          - binary_buildpack
        
    - name: Deploy  App
      run: cf push
